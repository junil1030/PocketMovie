# .github/workflows/iOS-CI.yml
name: iOS CI Pipeline

# íŠ¸ë¦¬ê±° ì¡°ê±´
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]
    
# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
env:
  XCODE_VERSION: '16.2'
  IOS_SIMULATOR: 'iPhone 16'
  IOS_VERSION: '18.3'

jobs:
  # 1ë‹¨ê³„: ë¹Œë“œ ì²´í¬
  build:
    name: Build Check
    runs-on: macos-13
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Setup Xcode Version
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}
    
    - name: Build Project
      run: |
        xcodebuild clean build \
          -project PocketMovie.xcodeproj \
          -scheme PocketMovie \
          -destination 'platform=iOS Simulator,name=${{ env.IOS_SIMULATOR }},OS=${{ env.IOS_VERSION }}' \
          CODE_SIGNING_ALLOWED=NO
          
  # 2ë‹¨ê³„: ìœ ë‹› í…ŒìŠ¤íŠ¸
  unit-tests:
    name: Unit Tests
    runs-on: macos-13
    needs: build
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}
    
    # API í‚¤ë“¤ì„ í™˜ê²½ë³€ìˆ˜ë¡œ ì„¤ì •
    - name: Setup Environment Variables
      run: |
        echo "TMDB_API_KEY=${{ secrets.TMDB_API_KEY }}" >> $GITHUB_ENV
        echo "KOBIS_API_KEY=${{ secrets.KOBIS_API_KEY }}" >> $GITHUB_ENV
        echo "CI=true" >> $GITHUB_ENV
    
    - name: Run Unit Tests
      run: |
        xcodebuild test \
          -project PocketMovie.xcodeproj \
          -scheme PocketMovie \
          -destination 'platform=iOS Simulator,name=${{ env.IOS_SIMULATOR }},OS=${{ env.IOS_VERSION }}' \
          -only-testing:PocketMovieTests \
          -enableCodeCoverage YES \
          -resultBundlePath TestResults-Unit.xcresult
    
    # í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
    - name: Upload Unit Test Results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: unit-test-results
        path: TestResults-Unit.xcresult
        retention-days: 7

# 3ë‹¨ê³„: UI í…ŒìŠ¤íŠ¸
  ui-tests:
    name: UI Tests
    runs-on: macos-13
    needs: build
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}
    
    - name: Setup Environment Variables
      run: |
        echo "TMDB_API_KEY=${{ secrets.TMDB_API_KEY }}" >> $GITHUB_ENV
        echo "KOBIS_API_KEY=${{ secrets.KOBIS_API_KEY }}" >> $GITHUB_ENV
        echo "CI=true" >> $GITHUB_ENV
    
    - name: Prepare Simulator
      run: |
        xcrun simctl list devices available
        xcrun simctl boot "${{ env.IOS_SIMULATOR }}" || true
        xcrun simctl bootstatus "${{ env.IOS_SIMULATOR }}" -b
    
    - name: Run UI Tests
      run: |
        xcodebuild test \
          -project PocketMovie.xcodeproj \
          -scheme PocketMovie \
          -destination 'platform=iOS Simulator,name=${{ env.IOS_SIMULATOR }},OS=${{ env.IOS_VERSION }}' \
          -only-testing:PocketMovieUITests \
          -resultBundlePath TestResults-UI.xcresult
    
    - name: Upload UI Test Results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: ui-test-results
        path: TestResults-UI.xcresult
        retention-days: 7

  # 4ë‹¨ê³„: Slack ì•Œë¦¼
  notify-results:
    name: Notify Results
    runs-on: macos-13
    needs: [build, unit-tests, ui-tests]
    if: always()  # ì„±ê³µ/ì‹¤íŒ¨ ê´€ê³„ì—†ì´ ì‹¤í–‰
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    
    - name: Get Test Results Summary
      id: test-summary
      run: |
        # ê°„ë‹¨í•œ ê²°ê³¼ ìš”ì•½ ìƒì„±
        if [[ "${{ needs.build.result }}" == "success" && "${{ needs.unit-tests.result }}" == "success" && "${{ needs.ui-tests.result }}" == "success" ]]; then
          echo "status=success" >> $GITHUB_OUTPUT
          echo "message=ëª¨ë“  ë¹Œë“œì™€ í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µí–ˆìŠµë‹ˆë‹¤! âœ…" >> $GITHUB_OUTPUT
        else
          echo "status=failure" >> $GITHUB_OUTPUT
          echo "message=ë¹Œë“œ ë˜ëŠ” í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. âŒ" >> $GITHUB_OUTPUT
        fi
        
        # ê° ë‹¨ê³„ë³„ ìƒíƒœ ì²´í¬
        echo "build_status=${{ needs.build.result }}" >> $GITHUB_OUTPUT
        echo "unit_test_status=${{ needs.unit-tests.result }}" >> $GITHUB_OUTPUT
        echo "ui_test_status=${{ needs.ui-tests.result }}" >> $GITHUB_OUTPUT
    
    - name: Send Success Notification to Slack
      if: steps.test-summary.outputs.status == 'success'
      uses: 8398a7/action-slack@v3
      with:
        status: success
        channel: '#ios-builds'
        username: 'PocketMovie Bot'
        icon_emoji: ':iphone:'
        title: 'âœ… PocketMovie ë¹Œë“œ ì„±ê³µ!'
        fields: |
          [
            {
              "title": "ë¸Œëœì¹˜",
              "value": "${{ github.ref_name }}",
              "short": true
            },
            {
              "title": "ì»¤ë°‹",
              "value": "${{ github.sha }}",
              "short": true
            },
            {
              "title": "ì‘ì„±ì",
              "value": "${{ github.actor }}",
              "short": true
            },
            {
              "title": "ë¹Œë“œ ì‹œê°„",
              "value": "${{ github.run_number }}",
              "short": true
            }
          ]
        text: |
          ğŸ‰ ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ í†µê³¼í–ˆìŠµë‹ˆë‹¤!
          
          ğŸ“± **ë¹Œë“œ**: ${{ steps.test-summary.outputs.build_status }}
          ğŸ§ª **ìœ ë‹› í…ŒìŠ¤íŠ¸**: ${{ steps.test-summary.outputs.unit_test_status }}
          ğŸ­ **UI í…ŒìŠ¤íŠ¸**: ${{ steps.test-summary.outputs.ui_test_status }}
          
          <${{ github.event.head_commit.url }}|ì»¤ë°‹ í™•ì¸í•˜ê¸°>
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
    
    - name: Send Failure Notification to Slack
      if: steps.test-summary.outputs.status == 'failure'
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        channel: '#ios-builds'
        username: 'PocketMovie Bot'
        icon_emoji: ':warning:'
        title: 'âŒ PocketMovie ë¹Œë“œ ì‹¤íŒ¨'
        fields: |
          [
            {
              "title": "ë¸Œëœì¹˜",
              "value": "${{ github.ref_name }}",
              "short": true
            },
            {
              "title": "ì»¤ë°‹",
              "value": "${{ github.sha }}",
              "short": true
            },
            {
              "title": "ì‘ì„±ì",
              "value": "${{ github.actor }}",
              "short": true
            },
            {
              "title": "ì‹¤íŒ¨í•œ Job",
              "value": "${{ steps.test-summary.outputs.message }}",
              "short": false
            }
          ]
        text: |
          ğŸš¨ ë¹Œë“œ ë˜ëŠ” í…ŒìŠ¤íŠ¸ì—ì„œ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
          
          ğŸ“± **ë¹Œë“œ**: ${{ steps.test-summary.outputs.build_status }}
          ğŸ§ª **ìœ ë‹› í…ŒìŠ¤íŠ¸**: ${{ steps.test-summary.outputs.unit_test_status }}
          ğŸ­ **UI í…ŒìŠ¤íŠ¸**: ${{ steps.test-summary.outputs.ui_test_status }}
          
          <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|ë¡œê·¸ í™•ì¸í•˜ê¸°>
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}


          
